name: $(TeamProject)-$(BuildDefinitionName)-$(SourceBranchName)-$(Date:yyyy.MM.dd)-$(Rev:rr)

trigger: none

resources:
  containers:
    - container: universal_linux
      image: universal_linux
      endpoint: featurizersbuild

stages:
  # Windows/clang/x64 [Official build]
  - template: BuildAndTest.stage_template.yaml
    parameters:
      agent_pool: windows-2019
      operating_system: Windows
      configuration: x64
      enable_code_coverage: True

  # TODO: # Linux/GCC/universal_linux [Official build]
  # TODO: - template: BuildAndTest.stage_template.yaml
  # TODO:   parameters:
  # TODO:     agent_pool: ubuntu-16.04
  # TODO:     agent_pool_container: universal_linux
  # TODO:     operating_system: Linux
  # TODO:     configuration: universal_linux
  # TODO:     enable_code_coverage: False

  # Windows/MSVC/x64
  - template: BuildAndTest.stage_template.yaml
    parameters:
      agent_pool: windows-2019
      operating_system: Windows
      configuration: x64_MSVC
      enable_code_coverage: False

  # Linux/clang/x64
  - template: BuildAndTest.stage_template.yaml
    parameters:
      agent_pool: ubuntu-16.04
      operating_system: Linux
      configuration: x64
      enable_code_coverage: False

  # Linux/GCC/system_compiler
  - template: BuildAndTest.stage_template.yaml
    parameters:
      agent_pool: ubuntu-16.04
      operating_system: Linux
      configuration: system_compiler
      enable_code_coverage: False

  # TODO: MacOS Build

  - template: Package.stage_template.yaml
    parameters:
      agent_pool: windows-2019
      operating_system: Windows
      configuration: system_compiler
      dependencies:
        - BuildAndTest_Windows_x64_Stage
        # TODO: - BuildAndTest_Linux_universal_linux_Stage
        - BuildAndTest_Windows_x64_MSVC_Stage
        - BuildAndTest_Linux_x64_Stage
        - BuildAndTest_Linux_system_compiler_Stage
